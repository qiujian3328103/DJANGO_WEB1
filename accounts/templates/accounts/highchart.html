<!-- https://mdbootstrap.com/docs/standard/extended/multiselect/ -->
<!-- https://colorlib.com/wp/template/multiselect-02/ -->
{% extends "accounts/base.html" %}
{% load static %}

{% block extra_css %}
<style>
    /* Style the table container */
        .table-container {
        width: 100%;
        overflow-y: auto; /* Enable vertical scrolling */
        max-height: 400px; /* Set the maximum height for scrolling */
    }
    /* Place the CSS code here */
    /* Style the DataTable container */
    #dataTableContainer {
        border-collapse: collapse;
        width: 100%;
    }

    /* Reduce font size of DataTable */
    #dataTableContainer {
        font-size: 14px; /* Adjust the font size as needed */
    }

    /* Reduce row height of DataTable */
    #dataTableContainer tbody tr {
        height: 10px; /* Adjust the row height as needed */
    }

    /* Style table header */
    #dataTableContainer thead th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #ddd;
        text-align: left;
        padding: 8px;
    }

    /* Style table rows */
    #dataTableContainer tbody td {
        border-bottom: 1px solid #ddd;
        padding: 8px;
    }

    /* Add hover effect to table rows */
    #dataTableContainer tbody tr:hover {
        background-color: #f2f2f2;
    }
</style>
{% endblock %}

{% block title %}Highcharts Dashboard{% endblock %}

{% block content %}
    <div class="container mt-4">
        <h2>Highcharts Dashboard</h2>
        <div class="widget_box p-3 rounded" style="background-color: #f8f9fa;">
            <div class="row align-items-center">
                <div class="col-md-2 mt-0 p-1">
                    <select id="plotTypeSelect" class="browser-default custom-select">
                        <option value="bar">Bar</option>
                        <option value="line">Line</option>
                        <option value="bin_group">Bin Group</option>
                    </select>
                </div>
                <div class="col-md-2 mt-0 p-1">
                    <select id="groupDateSelect" class="browser-default custom-select">
                        <option value="Week">Week</option>
                        <option value="Month">Month</option>
                        <option value="Quarter">Quarter</option>                        
                    </select>
                </div>
                <div class="col-md-3 mt-0 p-1">
                    <select id="productID" class="browser-default custom-select">
                        {% for product in product_data %}
                        <option value="{{ product.product_id }}">{{ product.product_id }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2 mt-0 p-1">
                    <!-- <label for="startDatePicker">Start Date:</label> -->
                    <input type="date" id="startDatePicker" class="form-control" value="{{ default_start_date }}">
                </div>
                <div class="col-md-2 mt-0 p-1">
                    <!-- <label for="endDatePicker">End Date:</label> -->
                    <input type="date" id="endDatePicker" class="form-control" value="{{ default_end_date }}">
                </div>
            </div>

            <div class="row align-items-center">
                <div class="col-md-12 p-1">
                    <label>Select Bins</label>
                    <select id="binType" multiple="" class="label ui selection fluid dropdown">
                        {% for group in unique_bin_groups %}
                        <option value="{{ group }}">{{ group }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        <!-- create the highchart div to show the plot -->
        <div class="widget_box mt-4 p-3 rounded" style="background-color: #f8f9fa;">
            <div class="row">
                <div class="col-md-12">
                    <div id="chartContainer" style="width: 100%; height: 400px;"></div>
                </div>
            </div>
        </div>
        <!-- create a new div for the datatables  -->
        <div class="widget_box mt-4 p-3 rounded" style="background-color: #f8f9fa;">
            <div class="row">
                <div class="col-md-12">
                    <table id="dataTableContainer" class="display" style="width:100%"></table> <!-- Add this table element -->
                </div>
            </div>
        </div>
        
        <!-- create a table model -->
        <div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="detailsModalLabel">Details for <span id="modalDate"></span></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <table id="detailsDataTable" class="display" style="width:100%"></table>
                    </div>
                </div>
            </div>
        </div>
    </div>

 

    <!-- Mutliselect import the mutli select dorpdown widget  -->
    <script src="{%static 'multiselect-02/js/jquery.min.js' %}"></script>
    <script src="{%static 'multiselect-02/js/popper.js' %}"></script>
    <script src="{%static 'multiselect-02/js/bootstrap.min.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.2.13/dist/semantic.min.js"></script>
    <script src="{%static 'multiselect-02/js/main.js' %}"></script>
    
    <!-- highcharts libaray include for highchart   -->
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>

    <!-- jquery datatable include for data table   -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.10.2/umd/popper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/progressbar.js/1.1.0/progressbar.min.js"></script>

    <script>
        var plotTypeSelect = document.getElementById('plotTypeSelect');
        var startDatePicker = document.getElementById('startDatePicker');
        var endDatePicker = document.getElementById('endDatePicker');
        var groupDateSelect = document.getElementById('groupDateSelect');
        var chart;  // Variable to store the Highcharts chart instance

        if(plotTypeSelect.value === "bar"){
            var plot_type = "column"
        }else if(plotTypeSelect.value == "line"){
            var plot_type = "line"
        }else{
            // force to other options to vertical bar chart
            var plot_type = "column"
        }

        function createChart(data) {
            // Destroy previous chart instance if exists
            if (chart) {
                chart.destroy();
            };
            if (data.chart_type === 'line' || data.chart_type === 'bar'){
                // console.log(data.chart_type);
                // console.log(data.x_labels);
                Highcharts.chart('chartContainer', {
                    chart: {
                            type:  data.chart_type
                        },
                        title: {
                            text: 'Average Yield Data by Month'
                        },
                        xAxis: {
                            categories: data.x_labels,
                            title: {
                                text: 'Month'
                            }
                        },
                        yAxis: {
                            title: {
                                text: 'Average Yield'
                            }
                        },
                        series: [{
                            name: 'Average Yield',
                            data: data.y_values
                        }],
                        legend: {
                            layout: 'vertical',
                            align: 'right',
                            verticalAlign: 'middle'
                        },
                        // Add other Highcharts options as needed
                });
            }else{
                // console.log(data.bin_types);
                Highcharts.chart('chartContainer', {
                    chart: {
                        type: 'column'
                    },
                    title: {
                        text: 'Average Yield Data by Bin Type and Current Date'
                    },
                    xAxis: {
                        categories: data.bin_types,
                        title: {
                            text: 'Bin Type'
                        }
                    },
                    yAxis: {
                        title: {
                            text: 'Average Yield'
                        }
                    },
                    series: data.series,
                    legend: {
                            layout: 'vertical',
                            align: 'right',
                            verticalAlign: 'middle'
                        },
                });
            }
        }


        function updateChart() {
            var startDate = startDatePicker.value;
            var endDate = endDatePicker.value;
            var product_id = productID.value;
            var group_date = groupDateSelect.value;
            var selectedBinTypes = Array.from(binType.selectedOptions, option => option.value);

            fetch(`/get_data_highchart/?plot_type=${plotTypeSelect.value}&group_date=${group_date}&start_date=${startDate}&end_date=${endDate}&bin_types=${selectedBinTypes}&product_id=${product_id}`)
                .then(response => response.json())
                .then(data => {
                    // pass the data from view to js function to create highcharts
                    createChart(data.highcharts_data);
                    updateDataTable(data.datatable_data); 
                    
                });
        }

        function updateDataTable(data) {
            var dataTableContainer = document.getElementById('dataTableContainer');
            var current_plot_type = plotTypeSelect.value;
            var dataTable;
            
            // Destroy existing DataTable if it exists
            if ($.fn.DataTable.isDataTable(dataTableContainer)) {
                dataTable = $(dataTableContainer).DataTable();
                dataTable.clear().destroy();
            }
            // Create or update DataTable using the 'data' parameter
            // Define columns based on the chart_type
            var columns;
            if (current_plot_type === 'bar' || current_plot_type === 'line') {
                columns = [
                        { title: 'Date', data: 'current_date',
                            render: function(data, type, row){
                                // render link to click show modal 
                                if (type === 'display') {
                                    return '<a href="#" class="date-link">' + data + '</a>';
                                }
                                return data;
                            },
                        
                        },
                        { title: 'Total Lots', data: 'total_lots' },
                        { title: 'Total Wafers', data: 'total_wafers' },
                        { title: 'Average Yield', data: 'avg_yield' }
                    ];
            } else {
                    // Define columns for other chart types if needed
                    columns = [

                    ];
            }
            console.log(current_plot_type);
            console.log('columns:', columns);

            $(dataTableContainer).DataTable({
                destroy: true,
                scrollY: "200px", // add a scroll bar  
                data: data, // Replace with actual data from 'data' object
                columns: columns, 
                searching: false,   // Disable search bar
                paging: false,       // Disable pagination
                info: false  // Disable info display
            });


            $(document).ready(function() {
                dataTable = $('#dataTableContainer').DataTable();
            });

            // Handle click event for date link
            $('#dataTableContainer').on('click', '.date-link', function () {
                console.log($(this));

                var rowData = dataTable.row($(this).closest('tr')).data();
                var modalDate = rowData.current_date;

                $('#modalDate').text(modalDate);
                $('#detailsModal').modal('show');

                if ($.fn.dataTable.isDataTable('#detailsDataTable')) {
                    $('#detailsDataTable').DataTable().destroy();
                    }

                var detailsDataTable = $('#detailsDataTable').DataTable({
                    // ... options for the details DataTable ...
                    data: rowData.details, // Replace with the actual details data
                    columns: [
                        { title: 'Root Lot ID', data: 'root_lot_id' },
                        { title: 'Wafer ID', data: 'wafer_id' },
                        { title: 'Yield', data: 'yield_value' },
                        // ... other columns ...
                    ],
                    // ... other options ...
                });
            });

        }

        plotTypeSelect.addEventListener('change', updateChart);
        startDatePicker.addEventListener('change', updateChart);
        endDatePicker.addEventListener('change', updateChart);
        binType.addEventListener('change', updateChart);
        productID.addEventListener('change', updateChart);
        groupDateSelect.addEventListener('change', updateChart);

        // Calculate default start and end dates
        var currentDate = new Date();
        var defaultEndDate = currentDate.toISOString().split('T')[0];
        var fourteenDaysAgo = new Date(currentDate);
        fourteenDaysAgo.setDate(currentDate.getDate() - 14);
        var defaultStartDate = fourteenDaysAgo.toISOString().split('T')[0];

        startDatePicker.value = defaultStartDate;
        endDatePicker.value = defaultEndDate;

        // Call updateChart initially to populate the initial data
        updateChart();
    </script>
{% endblock %}




