{% extends "accounts/base.html" %}
{% load static %}
{% block title %}Highcharts Dashboard{% endblock %}

{% block content %}
    <div class="container mt-4">
        <h2>Highcharts Dashboard</h2>
        <div class="row">
            <div class="col-md-4">
                <label for="plotTypeSelect">Plot Type:</label>
                <select id="plotTypeSelect" class="form-select">
                    <option value="bar">Bar</option>
                    <option value="line">Line</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="startDatePicker">Start Date:</label>
                <input type="date" id="startDatePicker" class="form-control" value="{{ default_start_date }}">
            </div>
            <div class="col-md-4">
                <label for="endDatePicker">End Date:</label>
                <input type="date" id="endDatePicker" class="form-control" value="{{ default_end_date }}">
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-md-12">
                <div id="chartContainer" style="width: 800px; height: 400px;"></div>
            </div>
        </div>
    </div>


    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <script>
        var plotTypeSelect = document.getElementById('plotTypeSelect');
        var startDatePicker = document.getElementById('startDatePicker');
        var endDatePicker = document.getElementById('endDatePicker');
        var chart;  // Variable to store the Highcharts chart instance
        function createChart(xLabels, yValues) {
                        // Destroy previous chart instance if exists
            if (chart) {
                chart.destroy();
            };

            Highcharts.chart('chartContainer', {
                chart: {
                    type:  plotTypeSelect.value
                },
                title: {
                    text: 'Average Yield Data by Month'
                },
                xAxis: {
                    categories: xLabels,
                    title: {
                        text: 'Month'
                    }
                },
                yAxis: {
                    title: {
                        text: 'Average Yield'
                    }
                },
                series: [{
                    name: 'Average Yield',
                    data: yValues
                }],
                // Add other Highcharts options as needed
            });
        }

        function updateChart() {
            var startDate = startDatePicker.value;
            var endDate = endDatePicker.value;


            console.log(startDate);
            console.log(endDate);

            fetch(`/get_data_highchart/?plot_type=${plotTypeSelect.value}&start_date=${startDate}&end_date=${endDate}`)
                .then(response => response.json())
                .then(data => {
                    console.log(data.y_values);
                    createChart(data.x_labels, data.y_values);
                    
                });
        }

        plotTypeSelect.addEventListener('change', updateChart);
        startDatePicker.addEventListener('change', updateChart);
        endDatePicker.addEventListener('change', updateChart);

        // Calculate default start and end dates
        var currentDate = new Date();
        var defaultEndDate = currentDate.toISOString().split('T')[0];
        var fourteenDaysAgo = new Date(currentDate);
        fourteenDaysAgo.setDate(currentDate.getDate() - 14);
        var defaultStartDate = fourteenDaysAgo.toISOString().split('T')[0];

        startDatePicker.value = defaultStartDate;
        endDatePicker.value = defaultEndDate;

        // Call updateChart initially to populate the initial data
        updateChart();
    </script>
{% endblock %}




